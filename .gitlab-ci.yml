# vim: set ts=2 sts=2 sw=2:

---
stages:
  - build-test
  - package
  - deploy

build-2.7:
  image: python:2.7-alpine
  stage: build-test
  script:
    - apk update && apk add git bash
    - pip install --upgrade virtualenv
    - virtualenv .
    - . bin/activate
    - pip install -r requirements.txt
    - nosetests --with-coverage

build-3.3:
  image: python:3.3-alpine
  stage: build-test
  script:
    - apk update && apk add git bash
    - pip install --upgrade virtualenv
    - virtualenv .
    - . bin/activate
    - pip install -r requirements.txt
    - nosetests --with-coverage

build-3.4:
  image: python:3.4-alpine
  stage: build-test
  script:
    - apk update && apk add git bash
    - pip install --upgrade virtualenv
    - virtualenv .
    - . bin/activate
    - pip install -r requirements.txt
    - nosetests --with-coverage

build-3.5:
  image: python:3.5-alpine
  stage: build-test
  script:
    - apk update && apk add git bash
    - pip install --upgrade virtualenv
    - virtualenv .
    - . bin/activate
    - pip install -r requirements.txt
    - nosetests --with-coverage

build-3.6:
  image: python:3.6-alpine
  stage: build-test
  script:
    - apk update && apk add git bash
    - pip install --upgrade virtualenv
    - virtualenv .
    - . bin/activate
    - pip install -r requirements.txt
    - nosetests --with-coverage

global-package:
  image: pirogoeth/py3.5-ci:latest
  stage: package
  script:
    - apk update && apk add git bash
    - python ./setup.py sdist --formats gztar -q
  only:
    - master
  artifacts:
    paths:
      - dist/

global-deploy:
  image: pirogoeth/py3.5-ci:latest
  stage: deploy
  script:
    - which ssh-agent || ( apk add openssh-client )
    - which git || ( apk add git )
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv || -f /.dockerinit ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - git remote add deploy git@github.com:maiome-development/malibu.git
    - git push deploy master
  only:
    - master
